# CI Pipeline - Lint, Test, Build
# Generated by Multi-Agent Framework
#
# Installation:
#   Copy to .github/workflows/ci.yml in your project

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  # ===========================================================================
  # Spec Validation (Spec-First Enforcement)
  # ===========================================================================
  spec-validation:
    name: Spec Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate OpenAPI spec
        run: |
          if [ -f "specs/openapi.yaml" ]; then
            npx @apidevtools/swagger-cli validate specs/openapi.yaml
          else
            echo "No OpenAPI spec found - skipping"
          fi

      - name: Validate Prisma schema
        run: |
          if [ -f "prisma/schema.prisma" ]; then
            npx prisma validate
          else
            echo "No Prisma schema found - skipping"
          fi

      - name: Validate Zod schemas compile
        run: |
          if [ -f "specs/schemas/index.ts" ]; then
            npx tsc --noEmit -p specs/tsconfig.json || npx tsc --noEmit specs/schemas/index.ts
          else
            echo "No Zod schemas found - skipping"
          fi

      - name: Check spec immutability
        run: |
          if [ -f ".truth/truth.json" ]; then
            SPECS_LOCKED=$(grep -A 10 '"specs"' .truth/truth.json 2>/dev/null | grep -o '"locked"[[:space:]]*:[[:space:]]*true' | head -1 || true)
            if [ -n "$SPECS_LOCKED" ]; then
              echo "Specs are locked (G3 approved)"
              # Check if any spec files changed in this PR
              SPEC_CHANGES=$(git diff --name-only HEAD~1 | grep -E "^(specs/|prisma/schema\.prisma)" || true)
              if [ -n "$SPEC_CHANGES" ]; then
                echo "ERROR: Locked spec files were modified!"
                echo "$SPEC_CHANGES"
                exit 1
              fi
            fi
          fi

  # ===========================================================================
  # Lint & Type Check
  # ===========================================================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript type check
        run: npm run typecheck
        continue-on-error: false

  # ===========================================================================
  # Security Audit
  # ===========================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate

      - name: Check for secrets in code
        run: |
          if grep -r "PRIVATE_KEY\|SECRET_KEY\|API_KEY\|PASSWORD\|ACCESS_TOKEN" --include="*.ts" --include="*.tsx" --include="*.js" src/; then
            echo "Potential secrets found in code!"
            exit 1
          fi

  # ===========================================================================
  # Unit Tests
  # ===========================================================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test -- --coverage --watchAll=false

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # ===========================================================================
  # Build
  # ===========================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [spec-validation, lint, test, security]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: dist/
          retention-days: 7

  # ===========================================================================
  # Accessibility Audit (for UI projects)
  # ===========================================================================
  accessibility:
    name: Accessibility Audit
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build
          path: dist/

      - name: Install dependencies
        run: npm ci

      - name: Start preview server
        run: |
          npx serve -s dist -l 5173 &
          sleep 5

      - name: Run Lighthouse
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: http://localhost:5173
          configPath: .lighthouserc.json
          uploadArtifacts: true
        continue-on-error: true
