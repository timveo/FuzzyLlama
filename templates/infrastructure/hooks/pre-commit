#!/bin/bash
# Pre-commit hook for Multi-Agent Framework projects
# Enforces validation before commits to main/develop branches
#
# Installation:
#   cp templates/infrastructure/hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or use the setup script:
#   ./scripts/setup-hooks.sh

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "Running pre-commit validation..."

# Get current branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Check if we're on a protected branch
PROTECTED_BRANCHES="main master develop"

is_protected() {
    for protected in $PROTECTED_BRANCHES; do
        if [ "$BRANCH" = "$protected" ]; then
            return 0
        fi
    done
    return 1
}

# Track if any check fails
FAILED=0

# 1. Run npm audit (security check)
echo -e "\n${YELLOW}[1/4] Running security audit...${NC}"
if command -v npm &> /dev/null && [ -f "package.json" ]; then
    if npm audit --audit-level=moderate 2>/dev/null; then
        echo -e "${GREEN}Security audit passed${NC}"
    else
        echo -e "${RED}Security audit failed - moderate or higher vulnerabilities found${NC}"
        echo "Run 'npm audit' to see details, or 'npm audit fix' to attempt fixes"
        FAILED=1
    fi
else
    echo "Skipping npm audit (no package.json found)"
fi

# 2. Run linting
echo -e "\n${YELLOW}[2/4] Running linter...${NC}"
if [ -f "package.json" ] && grep -q '"lint"' package.json; then
    if npm run lint 2>/dev/null; then
        echo -e "${GREEN}Linting passed${NC}"
    else
        echo -e "${RED}Linting failed${NC}"
        FAILED=1
    fi
else
    echo "Skipping lint (no lint script found)"
fi

# 3. Run tests
echo -e "\n${YELLOW}[3/4] Running tests...${NC}"
if [ -f "package.json" ] && grep -q '"test"' package.json; then
    if npm test 2>/dev/null; then
        echo -e "${GREEN}Tests passed${NC}"
    else
        echo -e "${RED}Tests failed${NC}"
        FAILED=1
    fi
else
    echo "Skipping tests (no test script found)"
fi

# 4. Run project validation (if validate script exists and this is a generated project)
echo -e "\n${YELLOW}[4/4] Running project validation...${NC}"
# Only run validation if this looks like a generated project (has package.json)
# Skip for the framework repo itself (which has templates/ but no root package.json)
if [ -f "scripts/validate-project.sh" ] && [ -f "package.json" ]; then
    # Determine validation level based on branch
    if is_protected; then
        VALIDATION_LEVEL="g7"  # Full security validation for protected branches
    else
        VALIDATION_LEVEL="g6"  # Quality validation for feature branches
    fi

    # Pass current directory (.) as project path, then the gate level
    if ./scripts/validate-project.sh . $VALIDATION_LEVEL 2>/dev/null; then
        echo -e "${GREEN}Project validation passed (level: $VALIDATION_LEVEL)${NC}"
    else
        echo -e "${RED}Project validation failed${NC}"
        FAILED=1
    fi
elif [ -f "scripts/validate-project.sh" ] && [ -d "templates/" ]; then
    echo "Skipping project validation (framework repo detected)"
else
    echo "Skipping project validation (validate-project.sh or package.json not found)"
fi

# 5. Enforce spec immutability (if locked)
echo -e "\n${YELLOW}[5/6] Checking spec immutability...${NC}"
if [ -f "scripts/enforce-spec-immutability.sh" ]; then
    if ./scripts/enforce-spec-immutability.sh . 2>/dev/null; then
        echo -e "${GREEN}Spec immutability check passed${NC}"
    else
        echo -e "${RED}Spec immutability check failed - locked specs modified${NC}"
        FAILED=1
    fi
elif [ -f ".truth/truth.json" ]; then
    # Fallback: inline check using TruthStore if script not present
    # Check if specs.locked is true in truth.json
    SPECS_LOCKED=$(grep -A 10 '"specs"' .truth/truth.json 2>/dev/null | grep -o '"locked"[[:space:]]*:[[:space:]]*true' | head -1 || true)
    if [ -n "$SPECS_LOCKED" ]; then
        SPEC_FILES=$(git diff --cached --name-only | grep -E "^(specs/|prisma/schema\.prisma|src/models/)" || true)
        if [ -n "$SPEC_FILES" ]; then
            echo -e "${RED}BLOCKED: Locked spec files modified:${NC}"
            echo "$SPEC_FILES"
            echo "Specs are locked after G3 approval. Use change request process."
            FAILED=1
        else
            echo -e "${GREEN}Spec immutability check passed${NC}"
        fi
    else
        echo "Skipping spec immutability check (specs not locked in TruthStore)"
    fi
else
    echo "Skipping spec immutability check (no TruthStore found)"
fi

# 6. Check for secrets in staged files
echo -e "\n${YELLOW}[6/6] Checking for hardcoded secrets...${NC}"
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json)$' || true)

if [ -n "$STAGED_FILES" ]; then
    SECRET_PATTERNS="PRIVATE_KEY|SECRET_KEY|API_KEY|PASSWORD|ACCESS_TOKEN|BEARER"
    FOUND_SECRETS=$(echo "$STAGED_FILES" | xargs grep -l -E "$SECRET_PATTERNS" 2>/dev/null || true)

    if [ -n "$FOUND_SECRETS" ]; then
        echo -e "${RED}Potential secrets found in:${NC}"
        echo "$FOUND_SECRETS"
        echo "Review these files and use environment variables instead"
        FAILED=1
    else
        echo -e "${GREEN}No hardcoded secrets detected${NC}"
    fi
else
    echo "No relevant files staged for secret check"
fi

# Final result
echo ""
if [ $FAILED -eq 1 ]; then
    echo -e "${RED}Pre-commit validation FAILED${NC}"
    echo "Fix the issues above or use 'git commit --no-verify' to bypass (not recommended)"
    exit 1
else
    echo -e "${GREEN}Pre-commit validation PASSED${NC}"
    exit 0
fi
